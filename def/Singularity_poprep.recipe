BootStrap: docker
From: ubuntu:18.04

%files
  /home/quagadmin/source/popreport/home/popreport/production/apiis /root/apiis

%post
  #sed -i 's/main/main restricted universe/g' /etc/apt/sources.list
  apt-get update -y
  apt-get upgrade -y
  
  # basic system
  apt-get install -y vim build-essential sudo git apt-utils software-properties-common curl gdebi-core
  # locales
  apt-get install -y locales
  locale-gen en_US.UTF-8
  locale-gen de_CH.UTF-8

  #install tzdata package
  export DEBIAN_FRONTEND=noninteractive
  apt-get install -y tzdata
  # set your timezone
  echo 'Europe/Berlin' > /etc/timezone

  # pg
  apt-get install -y postgresql

  # poprep-req
  apt-get update -y
  apt-get install -y mutt
  apt-get install -y apache2
  apt-get install -y postfix
  apt-get install -y texlive
  apt-get install -y texinfo
  apt-get install -y gnuplot
  apt-get install -y gnuplot-nox
  apt-get install -y zip
  apt-get install -y unzip
  apt-get install -y gfortran
  apt-get install -y transfig
  apt-get install -y xinetd
  apt-get install -y fex fex-utils
  
  # special installation for pdftk which is no longer available
  curl -sSL http://launchpadlibrarian.net/337429932/libgcj-common_6.4-3ubuntu1_all.deb > libgcj-common_6.4-3ubuntu1_all.deb
  curl -sSL http://launchpadlibrarian.net/340410966/libgcj17_6.4.0-8ubuntu1_amd64.deb > libgcj17_6.4.0-8ubuntu1_amd64.deb
  curl -sSL http://launchpadlibrarian.net/277739894/pdftk_2.02-4build1_amd64.deb > pdftk_2.02-4build1_amd64.deb
  gdebi --n libgcj-common_6.4-3ubuntu1_all.deb
  gdebi --n libgcj17_6.4.0-8ubuntu1_amd64.deb
  gdebi --n pdftk_2.02-4build1_amd64.deb
  apt-get update
  rm -rf libgcj-common_6.4-3ubuntu1_all.deb libgcj17_6.4.0-8ubuntu1_amd64.deb pdftk_2.02-4build1_amd64.deb

  # re-configure papersize
  sed -i 's/letter/a4/' /etc/papersize
  paperconfig -p a4
  
  # add the user for poprep
  useradd popreport
  echo popreport:pass | chpasswd
  
  # prepare directory for poprep
  mkdir -p /home/popreport/production
  mv /root/apiis /home/popreport/production
  chmod 777 /home/popreport/production

  # add apiis_home to .bashrc
  (echo;echo '# add apiis_home';echo 'APIIS_HOME=/home/popreport/production/apiis') >> /home/popreport/.bashrc
  export PATH=$PATH:$APIIS_HOME/bin >> /home/popreport/.bashrc

  # check and install additional perl- and apt-packages
  /home/popreport/production/apiis/bin/apiis-test-dependencies -i -d
  
  # create pg-directories
  mkdir -p /var/lib/postgresql/incoming
  mkdir -p /var/lib/postgresql/done
  mkdir -p /var/lib/postgresql/projects
  
